<!doctype html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kelas Digital 6C SDN 19 Martapura</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ... (styles tetap sama) ... */
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
</head>
<body>
  <!-- ... (HTML structure tetap sama) ... -->

  <script>
    // KONFIGURASI GOOGLE SHEETS - TANPA API KEY
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTsBnVhAQmyqDsUKGUIFzihLFGOUkQpjZ-dehgFhyYypNcR5M_LtmNJ0sKh3RQDhv_Y1gASgz6ffVZz/pub?output=csv';

    // Mapping untuk sheet names
    const SHEET_MAPPING = {
      matematika: 0,
      ipas: 1, 
      indonesia: 2,
      inggris: 3,
      pkn: 4,
      pai: 5,
      budaya: 6,
      pjok: 7,
      koding: 8
    };

    const defaultConfig = {
      site_title: "Kelas Digital 6C SDN 19 Martapura",
      welcome_text: "Selamat Datang di Portal Pembelajaran Digital Kami",
      teacher_name: "Dian Agung Pamungkas, S.Pd",
      teacher_motto: "Belajar dengan Hati, Tumbuh dengan Prestasi",
      contact_phone: "0812-3456-7890",
      school_address: "Jl. Lintas Sumatera No.12, RT.01/RW.03, Kota Baru, Kec. Martapura, Kabupaten Ogan Komering Ulu Timur, Sumatera Selatan 32311",
      background_color: "#E0F2FE",
      surface_color: "#FFFFFF",
      text_color: "#111827",
      primary_action_color: "#3B82F6",
      secondary_action_color: "#10B981"
    };

    let config = { ...defaultConfig };
    let nilaiData = {};
    let currentSubject = 'matematika';

    const subjectInfo = {
      matematika: { icon: "ðŸ”¢", name: "Matematika", color: "#3B82F6" },
      ipas: { icon: "ðŸ”¬", name: "IPAS", color: "#10B981" },
      indonesia: { icon: "ðŸ“š", name: "Bahasa Indonesia", color: "#F59E0B" },
      inggris: { icon: "ðŸ—£ï¸", name: "Bahasa Inggris", color: "#EC4899" },
      pkn: { icon: "ðŸ›ï¸", name: "PKn", color: "#EF4444" },
      pai: { icon: "ðŸ•Œ", name: "PAI", color: "#06B6D4" },
      budaya: { icon: "ðŸŽ­", name: "Budaya Komering", color: "#6366F1" },
      pjok: { icon: "âš½", name: "PJOK", color: "#84CC16" },
      koding: { icon: "ðŸ’»", name: "Koding & AI", color: "#8B5CF6" }
    };

    // Fungsi untuk parse CSV
    function parseCSV(csvText) {
      const lines = csvText.split('\n');
      const result = [];
      const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
      
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        
        const obj = {};
        const currentline = lines[i].split(',').map(field => field.trim().replace(/"/g, ''));
        
        for (let j = 0; j < headers.length; j++) {
          obj[headers[j]] = currentline[j] || '';
        }
        result.push(obj);
      }
      
      return result;
    }

    // Fungsi untuk mengambil data dari CSV
    async function fetchDataFromCSV() {
      try {
        console.log('Mengambil data dari CSV...');
        const response = await fetch(CSV_URL);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const csvText = await response.text();
        console.log('Data CSV berhasil diambil');
        
        const data = parseCSV(csvText);
        console.log('Data parsed:', data);
        
        return data;
      } catch (error) {
        console.error('Error mengambil data CSV:', error);
        
        // Fallback data jika gagal mengambil dari CSV
        return generateFallbackData();
      }
    }

    // Fungsi untuk generate data fallback
    function generateFallbackData() {
      const siswaNames = [
        "Ahmad Rizki", "Siti Nurhaliza", "Budi Santoso", "Dewi Lestari", "Fajar Hidayat",
        "Rina Wati", "Andi Pratama", "Maya Sari", "Doni Setiawan", "Lina Marlina",
        "Rizky Pratama", "Sari Dewi", "Joko Susilo", "Nina Astuti", "Hendra Gunawan",
        "Dian Permatasari", "Eko Prasetyo", "Fitri Handayani", "Gunawan Wijaya", "Hesti Rahayu",
        "Irfan Maulana", "Juli Susanti", "Kurniawan Adi", "Lestari Ningrum", "Maman Suratman",
        "Nanda Putri", "Oki Setiawan", "Putri Anggraini"
      ];

      return siswaNames.map((nama, index) => ({
        'No': (index + 1).toString(),
        'Nama Siswa': nama,
        'NH 1': Math.floor(Math.random() * 30) + 70,
        'NH 2': Math.floor(Math.random() * 30) + 70,
        'NH 3': Math.floor(Math.random() * 30) + 70,
        'NH 4': Math.floor(Math.random() * 30) + 70,
        'NH 5': Math.floor(Math.random() * 30) + 70,
        'STS': Math.floor(Math.random() * 30) + 70,
        'SAS': Math.floor(Math.random() * 30) + 70
      }));
    }

    // Fungsi untuk memproses data dan mengelompokkan berdasarkan mata pelajaran
    function processDataForSubjects(rawData) {
      const processedData = {};
      
      // Untuk setiap mata pelajaran, kita buat data yang sama
      // (dalam implementasi nyata, CSV Anda harus memiliki kolom untuk setiap mata pelajaran)
      Object.keys(SHEET_MAPPING).forEach(subject => {
        processedData[subject] = rawData.map(student => ({
          nama: student['Nama Siswa'],
          nh1: parseInt(student['NH 1']) || 0,
          nh2: parseInt(student['NH 2']) || 0,
          nh3: parseInt(student['NH 3']) || 0,
          nh4: parseInt(student['NH 4']) || 0,
          nh5: parseInt(student['NH 5']) || 0,
          sts: parseInt(student['STS']) || 0,
          sas: parseInt(student['SAS']) || 0
        }));
      });
      
      return processedData;
    }

    // Fungsi untuk memuat semua data nilai
    async function loadAllNilaiData() {
      const loadingElements = document.querySelectorAll('.loading');
      loadingElements.forEach(el => el.style.display = 'flex');
      
      try {
        console.log('Memulai proses loading data...');
        
        // Ambil data dari CSV
        const rawData = await fetchDataFromCSV();
        console.log('Raw data received:', rawData);
        
        // Proses data untuk semua mata pelajaran
        nilaiData = processDataForSubjects(rawData);
        console.log('Processed data:', nilaiData);
        
        // Sembunyikan loading setelah data selesai dimuat
        loadingElements.forEach(el => el.style.display = 'none');
        
        // Perbarui tampilan
        showSubject(currentSubject);
        updateRankingTable();
        
        console.log('Data nilai berhasil dimuat');
        
      } catch (error) {
        console.error('Error memuat data nilai:', error);
        loadingElements.forEach(el => el.style.display = 'none');
        
        // Tampilkan pesan error
        showErrorMessage();
      }
    }

    function showErrorMessage() {
      const errorMsg = document.createElement('div');
      errorMsg.style.padding = '20px';
      errorMsg.style.background = '#FEE2E2';
      errorMsg.style.color = '#991B1B';
      errorMsg.style.borderRadius = '8px';
      errorMsg.style.textAlign = 'center';
      errorMsg.style.marginTop = '16px';
      errorMsg.innerHTML = `
        <p style="margin: 0 0 12px 0; font-weight: 600;">Gagal memuat data nilai dari Google Sheets.</p>
        <p style="margin: 0 0 16px 0; font-size: 14px;">Menggunakan data contoh untuk demonstrasi.</p>
        <button onclick="loadAllNilaiData()" style="padding: 8px 16px; background: #EF4444; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Coba Lagi</button>
      `;
      
      const container = document.getElementById('nilai-detail-container');
      const existingError = container.querySelector('.error-message');
      if (!existingError) {
        errorMsg.classList.add('error-message');
        container.appendChild(errorMsg);
      }
    }

    function calculateAverage(student) {
      const values = [student.nh1, student.nh2, student.nh3, student.nh4, student.nh5, student.sts, student.sas];
      const validValues = values.filter(val => !isNaN(val) && val > 0);
      
      if (validValues.length === 0) return 0;
      
      const sum = validValues.reduce((a, b) => a + b, 0);
      return (sum / validValues.length).toFixed(1);
    }

    function getPredikat(avg) {
      const numericAvg = parseFloat(avg);
      if (numericAvg >= 90) return { label: 'A', bg: '#FEF3C7', color: '#92400E' };
      if (numericAvg >= 80) return { label: 'B', bg: '#DBEAFE', color: '#1E40AF' };
      if (numericAvg >= 70) return { label: 'C', bg: '#D1FAE5', color: '#065F46' };
      if (numericAvg >= 60) return { label: 'D', bg: '#FEE2E2', color: '#991B1B' };
      return { label: 'E', bg: '#F3F4F6', color: '#6B7280' };
    }

    function updateRankingTable() {
      if (!nilaiData.matematika || nilaiData.matematika.length === 0) {
        console.warn('Data matematika tidak tersedia untuk perhitungan ranking');
        return;
      }

      const studentAverages = [];
      const allStudents = nilaiData.matematika;

      allStudents.forEach((student, index) => {
        let totalAverage = 0;
        let subjectCount = 0;

        // Hitung rata-rata dari setiap mata pelajaran
        Object.keys(nilaiData).forEach(subject => {
          if (nilaiData[subject] && nilaiData[subject][index]) {
            const studentData = nilaiData[subject][index];
            const avg = parseFloat(calculateAverage(studentData));
            if (!isNaN(avg)) {
              totalAverage += avg;
              subjectCount++;
            }
          }
        });

        if (subjectCount > 0) {
          const overallAverage = totalAverage / subjectCount;
          studentAverages.push({
            nama: student.nama,
            average: overallAverage
          });
        }
      });

      // Sort berdasarkan rata-rata tertinggi
      studentAverages.sort((a, b) => b.average - a.average);

      // Ambil 10 besar
      const top10 = studentAverages.slice(0, 10);

      // Update tabel ranking
      const tbody = document.getElementById('ranking-table-body');
      if (!tbody) {
        console.error('Element ranking-table-body tidak ditemukan');
        return;
      }
      
      tbody.innerHTML = '';

      top10.forEach((student, index) => {
        const rank = index + 1;
        const avg = student.average.toFixed(1);
        const predikat = getPredikat(parseFloat(avg));
        
        let rankDisplay = rank.toString();
        let bgColor = 'white';
        let textColor = '#374151';
        
        if (rank === 1) {
          rankDisplay = 'ðŸ¥‡ 1';
          bgColor = '#FEF3C7';
          textColor = '#92400E';
        } else if (rank === 2) {
          rankDisplay = 'ðŸ¥ˆ 2';
          bgColor = '#E5E7EB';
          textColor = '#6B7280';
        } else if (rank === 3) {
          rankDisplay = 'ðŸ¥‰ 3';
          bgColor = '#FED7AA';
          textColor = '#C2410C';
        } else {
          bgColor = index % 2 === 1 ? '#F9FAFB' : 'white';
        }

        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #E5E7EB';
        row.style.background = bgColor;
        
        row.innerHTML = `
          <td style="padding: 16px; font-weight: 700; color: ${textColor};">${rankDisplay}</td>
          <td style="padding: 16px; font-weight: 600; color: #111827;">${student.nama}</td>
          <td style="padding: 16px; text-align: center; font-weight: 700; color: ${textColor};">${avg}</td>
          <td style="padding: 16px; text-align: center;">
            <span style="background: ${predikat.bg}; color: ${predikat.color}; padding: 4px 12px; border-radius: 6px; font-weight: 600;">
              ${predikat.label}
            </span>
          </td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function showSubject(subject) {
      if (!subjectInfo[subject]) {
        console.error(`Subject ${subject} tidak dikenali`);
        return;
      }
      
      currentSubject = subject;
      
      // Update button styles
      document.querySelectorAll('.subject-btn').forEach(btn => {
        btn.style.border = '2px solid #E5E7EB';
      });
      
      const subjectBtn = document.getElementById('btn-' + subject);
      if (subjectBtn) {
        subjectBtn.style.border = '3px solid ' + subjectInfo[subject].color;
      }

      // Update title
      const info = subjectInfo[subject];
      const subjectTitle = document.getElementById('subject-title');
      if (subjectTitle) {
        subjectTitle.innerHTML = `
          <span style="font-size: 32px;">${info.icon}</span>
          Nilai ${info.name}
        `;
      }

      // Update table
      const data = nilaiData[subject] || [];
      const tbody = document.getElementById('nilai-table-body');
      if (!tbody) {
        console.error('Element nilai-table-body tidak ditemukan');
        return;
      }
      
      tbody.innerHTML = '';

      if (data.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `
          <td colspan="10" style="padding: 40px; text-align: center; color: #6B7280;">
            Data nilai untuk ${info.name} sedang dimuat...
          </td>
        `;
        tbody.appendChild(row);
        return;
      }

      data.forEach((student, index) => {
        const avg = calculateAverage(student);
        const row = document.createElement('tr');
        row.style.borderBottom = '1px solid #E5E7EB';
        row.style.background = index % 2 === 0 ? '#F9FAFB' : 'white';
        
        row.innerHTML = `
          <td style="padding: 14px 12px; color: #374151;">${index + 1}</td>
          <td style="padding: 14px 12px; font-weight: 600; color: #111827;">${student.nama}</td>
          <td style="padding: 14px 12px; text-align: center; color: #374151;">${student.nh1}</td>
          <td style="padding: 14px 12px; text-align: center; color: #374151;">${student.nh2}</td>
          <td style="padding: 14px 12px; text-align: center; color: #374151;">${student.nh3}</td>
          <td style="padding: 14px 12px; text-align: center; color: #374151;">${student.nh4}</td>
          <td style="padding: 14px 12px; text-align: center; color: #374151;">${student.nh5}</td>
          <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #374151;">${student.sts}</td>
          <td style="padding: 14px 12px; text-align: center; font-weight: 600; color: #374151;">${student.sas}</td>
          <td style="padding: 14px 12px; text-align: center; font-weight: 700; color: #111827; background: #F3F4F6;">${avg}</td>
        `;
        
        tbody.appendChild(row);
      });
    }

    function showPage(pageName) {
      const pages = document.querySelectorAll('.page-section');
      pages.forEach(page => page.classList.remove('active'));
      
      const targetPage = document.getElementById('page-' + pageName);
      if (targetPage) {
        targetPage.classList.add('active');
      }

      const navButtons = document.querySelectorAll('.nav-btn');
      navButtons.forEach(btn => {
        btn.style.background = 'white';
        btn.style.color = '#374151';
        btn.style.border = '1px solid #E5E7EB';
      });

      const activeButton = document.getElementById('nav-' + pageName);
      if (activeButton) {
        activeButton.style.background = config.primary_action_color;
        activeButton.style.color = 'white';
        activeButton.style.border = 'none';
      }

      window.scrollTo({ top: 0, behavior: 'smooth' });

      // Initialize nilai table if on nilai page
      if (pageName === 'nilai') {
        // Pastikan data sudah dimuat sebelum menampilkan
        if (Object.keys(nilaiData).length === 0) {
          loadAllNilaiData();
        } else {
          showSubject(currentSubject);
          updateRankingTable();
        }
      }
    }

    // ... (fungsi onConfigChange dan lainnya tetap sama) ...

    // Inisialisasi
    document.addEventListener('DOMContentLoaded', function() {
      console.log('DOM Content Loaded');
      
      // Muat data dari Google Sheets saat halaman dimuat
      loadAllNilaiData();
      
      // Set interval untuk refresh data setiap 30 detik
      setInterval(loadAllNilaiData, 30000);
    });

    // ... (SDK configuration tetap sama) ...
  </script>
</body>
</html>
